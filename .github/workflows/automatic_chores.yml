name: Automatic chores

on:
  push:
    branches:
      - dev
    paths:
      - ".github/workflows/automatic_chores.yml"
      - ".readme/*.md"
      - ".readme/blueprint.json"
      - ".changelog/*.md"
      - ".changelog/blueprint.json"
      - "server/**"
      - "client/**"
      - "shared/**"
      - "package.json"

jobs:
  automatic_chores:
    name: Automatic chores
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    if: "!contains(github.event.head_commit.message, '[skip-ci]')"
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Use Node.js (${{ vars.NODE_VERSION }})
        uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.NODE_VERSION }}
          cache: 'npm'

      - run: |
          npm ci --no-audit --no-fund --loglevel=error --include=dev

      - name: ESLint and prettier
        run: |
          npm run lint:fix
          npm run prettier:write

      - name: Generating README and CHANGELOG using @appnest/readme
        run: |
          npx concurrently \
          "npx @appnest/readme generate --config .readme/blueprint.json --silent" \
          "npx @appnest/readme generate --config .changelog/blueprint.json --silent"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.CI_BOT_TOKEN }}
          branch: auto/chores-${{ github.run_id }}
          base: dev
          title: "ü§ñ Automated chores"
          body: |
            Automated lint/readme updates from commit ${{ github.sha }}
            
            This PR contains automated changes from:
            - ESLint auto-fixes
            - Prettier formatting
            - README.md generation
            - CHANGELOG.md generation
            
            Generated by [automatic_chores.yml](https://github.com/Puzzlepart/did/blob/dev/.github/workflows/automatic_chores.yml)
            See [#903](https://github.com/Puzzlepart/did/issues/903) for more details.
          commit-message: "automatic chores üìù [skip-ci]"
          committer: github-automatic-chores <github-automatic-chores@users.noreply.github.com>
          author: github-automatic-chores <github-automatic-chores@users.noreply.github.com>
          delete-branch: true

      - name: Auto-approve Pull Request
        if: ${{ steps.cpr.outputs.pull-request-number }}
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.CI_BOT_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}

      - name: Enable auto-merge
        if: ${{ steps.cpr.outputs.pull-request-number }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.CI_BOT_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
