name: Automatic chores

on:
  push:
    branches:
      - dev
    paths:
      - ".github/workflows/automatic_chores.yml"
      - ".readme/*.md"
      - ".readme/blueprint.json"
      - ".changelog/*.md"
      - ".changelog/blueprint.json"
      - "package.json"
      - "package-lock.json"

jobs:
  automatic_chores:
    name: Automatic chores
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    if: "!contains(github.event.head_commit.message, '[skip-ci]')"
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Use Node.js (${{ vars.NODE_VERSION }})
        uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci --no-audit --no-fund --loglevel=error --include=dev

      - name: Generate README and CHANGELOG using @appnest/readme
        run: |
          npx concurrently \
            "npx @appnest/readme generate --config .readme/blueprint.json --silent" \
            "npx @appnest/readme generate --config .changelog/blueprint.json --silent"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.CI_BOT_TOKEN }}

          branch: auto/chores-${{ github.run_id }}-${{ github.run_attempt }}
          base: dev

          title: "ü§ñ Automated docs"
          body: |
            Automated README/CHANGELOG updates from commit ${{ github.sha }}

            Generated by [automatic_chores.yml](https://github.com/Puzzlepart/did/blob/dev/.github/workflows/automatic_chores.yml)

          commit-message: "docs: update readme/changelog üìù [skip-ci]"
          committer: github-automatic-chores <github-automatic-chores@users.noreply.github.com>
          author: github-automatic-chores <github-automatic-chores@users.noreply.github.com>
          delete-branch: true

          add-paths: |
            README.md
            CHANGELOG.md
            .readme/
            .changelog/

      - name: Enable auto-merge
        if: ${{ steps.cpr.outputs.pull-request-number }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.CI_BOT_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash